<html>
<head>

  <style>
   @font-face {
      font-family: "GeoSans";
      src: url("assets/GeosansLight.ttf");
    }
    html{ color:#ffc; background:#000; font-family:"GeoSans" }
    body{
      font-size:30px;
    }
    a{
      color: #fff;
    }
    #renderer{
      position:fixed;
      top:0px;
      left:0px;
    }
    code{
      color:#fff;
      font-size:20px;
    }
  </style>

</head>
<body style="margin:0px">

<script src="three.js"                        ></script>
<script src="lib/Tween.js"                    ></script>
<script src="lib/jquery.min.js"               ></script>
<script src="lib/stats.min.js"                ></script>
<script src="lib/underscore.js"               ></script>
<script src="lib/TrackballControls.js"        ></script>
<script src="lib/ShaderLoader.js"             ></script>
<script src="lib/ObjectControls.js"           ></script>
<script src="lib/MouseMoveControls.js"        ></script>
<script src="lib/PhysicsRenderer.js"          ></script>
<script src="lib/OBJLoader.js"                ></script>


<script src="lib/AudioController.js"          ></script>
<script src="lib/Stream.js"                   ></script>
<script src="lib/UserAudio.js"                ></script>

<script src="lib/AudioBuffer.js"              ></script>
<script src="lib/BufferedAudio.js"            ></script>

<script src="lib/TextCreator.js"              ></script>



<script src="Song.js"                         ></script>
<script src="GrowBar.js"                         ></script>

<script src="fishSkeleton.js"></script>
<script src="DragonFish.js"></script>
<script src="Fish.js"></script>


<script src="Tree.js"></script>



<script>


  G = {}

  var scene , camera , renderer, clock , controls, objectControls;

  var neededToLoad = 0;
  var numLoaded = 0;

  var iPoint;

  var loader = new THREE.TextureLoader();


  var shaders = new ShaderLoader( 'shaders' );

  //shaders.load( 'ss-curlFront'    , 'sim'    , 'simulation' );

  addLoad();

  shaders.load( 'fs-trace'  , 'trace' , 'fragment' );
  shaders.load( 'vs-trace'  , 'trace' , 'vertex'   );


  //TODOOOOO
  shaders.load( 'fs-water'  , 'water' , 'fragment' );
  shaders.load( 'vs-water'  , 'water' , 'vertex'   );

  shaders.load( 'fs-island'  , 'island' , 'fragment' );
  shaders.load( 'vs-island'  , 'island' , 'vertex'   );

  shaders.shaderSetLoaded = function(){
    onLoad();
  }

  addLoad();
  var matcap = loader.load('img/rough-aluminium.jpg',function ( texture ) {
    onLoad();
  });

  addLoad();
  //var normal = THREE.ImageUtils.loadTexture('img/t_n_mesh.png');
  var normal = loader.load('img/n_water.jpg',function(){
    onLoad();
  });
   


  var manager = new THREE.LoadingManager();
  var loader = new THREE.OBJLoader( manager );

  G.models = {}

  loadOBJ( 'leaf.obj', function(child){
    G.models.feather = child;
  })

  function loadOBJ( file , callback ){

    addLoad();

    loader.load( file, function ( object ) {

      object.traverse( function ( child ) {

        console.log( child.children );

        if ( child.children[0] instanceof THREE.Mesh ) {
          callback(child.children[0]);
        }else{
          console.log("NOPE");
        }

      });

      onLoad();

    });

  }


  normal.wrapT = normal.wrapS = THREE.RepeatWrapping;




  var songList = [
    "holdMe",
    "glistenVox",
    "lonely",
    "growSometimes",
    "oneonta",
    "midnight",
    "forPeter",
     "holdMe",
    "glistenVox",
    "lonely",
    "growSometimes",
    "oneonta",
    "midnight",
    "forPeter"
  ];

  var titleList = [
    "Hold Me",
    "Glisten",
    "Lonely",
    "Grow Sometimes",
    "Oneonta",
    "Midnight",
    "For Peter",
    "Hold Me",
    "Glisten",
    "Lonely",
    "Grow Sometimes",
    "Oneonta",
    "Midnight",
    "For Peter"
  ];

  var songs =[];

  var activeLink = undefined;
  var hoveredLink = undefined;

  var finalSongVal = 0;

  var uniforms = {
    t_audio:  { type:"t"  , value : null },
    dT:       { type:"f"  , value : 0             },
    time:     { type:"f"  , value : 0             },
    lightPos: { type:"v3" , value : null          },
    iModelMat:{ type:"m4" , value: new THREE.Matrix4() },
    t_matcap: { type:"t", value: matcap},
    t_normal: { type:"t", value: normal},
    t_text:   { type:"t", value: null },
    textRatio: {type:"f", value: 1 },

    light1 : {type:"v4",value:new THREE.Vector4()},
    light2 : {type:"v4",value:new THREE.Vector4()},
    light3 : {type:"v4",value:new THREE.Vector4()},

    dimensions: {type:"v3", value: new THREE.Vector3() },

    links: { type:"v4v" , value:[] },
    activeLink: { type:"v4" , value:new THREE.Vector4() },
    hoveredLink: { type:"v4" , value:new THREE.Vector4() },
    songVal:{type:"f",value:0},

    interfaceRadius: {type:"f", value:2 }
  }


  G.v1 = new THREE.Vector3();
  G.v2 = new THREE.Vector3();

  G.uniforms = uniforms;





  TWEEN.origTween = TWEEN.Tween;
  TWEEN.Tween = function (options){
    var res = new TWEEN.origTween(options);
    res.easing(TWEEN.Easing.Quadratic.InOut);
    return res;
  };


  /*

     Setting up Audio

  */
  var audio = new AudioController();

  var stream = new Stream( "audio/glistenVox.mp3" , audio.ctx , audio.gain );

  //var userAudio = new UserAudio( audio.ctx , audio.gain);

  audio.mute.gain.value = 0;
  uniforms.t_audio.value = audio.texture;

  var v1 = new THREE.Vector3();
  
  function init(){


      textCreator =  new TextCreator( 100 );


      test = textCreator.createTexture( "test" , {
        size: .03
      });

      uniforms.t_text.value = test;

      /*
         Default threejs stuff!
      */
      scene = new THREE.Scene();

      var ar = window.innerWidth / window.innerHeight;

      camera = new THREE.PerspectiveCamera( 40, ar , .01, 40 );
      camera.position.z = 13;
      //camera.position.y = 10;

      renderer = new THREE.WebGLRenderer();
      renderer.setSize( window.innerWidth, window.innerHeight );
      renderer.setPixelRatio( 2 )

      renderer.domElement.id = "renderer"
      document.body.appendChild( renderer.domElement );

      objectControls = new ObjectControls( camera );

     // controls = new THREE.TrackballControls( camera );

      controls = new THREE.MouseMoveControls( camera );
      //controls.noRotate = true;

      controls.center = new THREE.Vector3( 0,0.5,0);


      stats = new Stats();
      stats.domElement.style.position = "absolute";
      stats.domElement.style.left = "0px";
      stats.domElement.style.bottom = "-30px";
      stats.domElement.style.zIndex = "999";
      document.body.appendChild( stats.domElement );


      window.addEventListener( 'resize', onWindowResize, false );

      clock = new THREE.Clock();



      var geo = new THREE.PlaneGeometry( 10 , 10 , 100 , 100);
       var mat  = new THREE.ShaderMaterial({
        uniforms: uniforms,
        vertexShader: shaders.vs.island,
        fragmentShader: shaders.fs.island,

      });

      var island = new THREE.Mesh( geo , mat );
      island.position.y = -1;
      island.position.x = 1;
      island.position.z = -.5;
      island.rotation.z = -.4;
      island.rotation.x = -Math.PI * .5;
      scene.add( island );



      var geo = new THREE.PlaneGeometry( 25 , 25 , 100 , 100);
      var mat  = new THREE.ShaderMaterial({
        uniforms: uniforms,
        vertexShader: shaders.vs.water,
        fragmentShader: shaders.fs.water,
        transparent: true
      });

      var water = new THREE.Mesh( geo , mat );
      water.position.y = -1;
      water.rotation.z = -.4;
      water.rotation.x = -Math.PI * .5;

      water.position.copy( island.position )

      scene.add( water );



      var d = new THREE.Vector3(1.3 , 2.9 , .6 );
      G.uniforms.dimensions.value.x = d.x
      G.uniforms.dimensions.value.y = d.y
      G.uniforms.dimensions.value.z = d.z



      var geo = new THREE.BoxGeometry( d.x , d.y , d.z );
      var mat = new THREE.MeshNormalMaterial();


      var raytraceMat = new THREE.ShaderMaterial({
        uniforms: uniforms,
        vertexShader: shaders.vs.trace,
        fragmentShader: shaders.fs.trace,
      });


      var monolith = new THREE.Mesh( geo , raytraceMat );
      monolith.position.y = 1.8;
      monolith.position.x = 1.3;

      monolith.position.z = -1.;
      monolith.rotation.y = 0;

      monolith.scale.multiplyScalar( 1.6 );



      scene.add( monolith );

      G.monolith = monolith;



      var globeRad = .8;
      var globePos = new THREE.Vector3( 0.2 , 2.4 , .1);



  var sphere = new THREE.Mesh( new THREE.IcosahedronGeometry( globeRad , 2 ), new THREE.MeshBasicMaterial());
  G.light1 = sphere;
      sphere.position.copy(globePos);
      var params  = {
        material:               new THREE.MeshNormalMaterial(),
        radius:                 .2,
        height:                 2.5,
        sides:                  10,
        numOf:                  10, 
        randomness:             .3,
        slices:                 100,
        lightPosition:          new THREE.Vector3().copy( globePos ) ,
        lightSize:              globeRad,
        startingChance:          20.,
        chanceReducer:           .99,
        randomnessReducer:       .99,
        sliceReducer:            .4,
        numOfReducer:            .9,
        progressionPower:        2.2,
        lengthReduction:         .6,
        maxIterations:           3,
        flattening:              1.2,
        maxVerts:      100000
      }
      var tree = new Tree( params );

      tree.position.x = 3.5;
      tree.position.z = -1;
      tree.position.y = -1;
      tree.scale.multiplyScalar( .6 );
      scene.add( tree );
      tree.add(sphere);






      var globeRad = .7;
      var globePos = new THREE.Vector3( -0.2 , 2.7 , -.1);

  var sphere = new THREE.Mesh( new THREE.IcosahedronGeometry( globeRad , 2 ), new THREE.MeshBasicMaterial());


      G.light2 = sphere;

      sphere.position.copy(globePos);
      var params  = {
        material:               new THREE.MeshNormalMaterial(),
        radius:                 .2,
        height:                 2.5,
        sides:                  10,
        numOf:                  10, 
        randomness:             .3,
        slices:                 100,
        lightPosition:          new THREE.Vector3().copy( globePos ) ,
        lightSize:              globeRad,
        startingChance:          20.,
        chanceReducer:           .99,
        randomnessReducer:       .99,
        sliceReducer:            .4,
        numOfReducer:            .9,
        progressionPower:        2.2,
        lengthReduction:         .6,
        maxIterations:           3,
        flattening:              1.2,
        maxVerts:      100000
      }
      var tree = new Tree( params );

      tree.position.x = 0.2;
      tree.position.z = 1;
      tree.position.y = -1;
      tree.scale.multiplyScalar( .5 );
      scene.add( tree );
      tree.add(sphere);
     

     var globeRad = .7;
      var globePos = new THREE.Vector3( 0 , 2.2 , 0);


  var sphere = new THREE.Mesh( new THREE.IcosahedronGeometry( globeRad , 2 ), new THREE.MeshBasicMaterial());

  G.light3 = sphere;


      sphere.position.copy(globePos);
      var params  = {
        material:               new THREE.MeshNormalMaterial(),
        radius:                 .2,
        height:                 2.5,
        sides:                  10,
        numOf:                  10, 
        randomness:             .3,
        slices:                 100,
        lightPosition:          new THREE.Vector3().copy( globePos ) ,
        lightSize:              globeRad,
        startingChance:          20.,
        chanceReducer:           .99,
        randomnessReducer:       .99,
        sliceReducer:            .4,
        numOfReducer:            .9,
        progressionPower:        2.2,
        lengthReduction:         .6,
        maxIterations:           3,
        flattening:              1.2,
        maxVerts:      100000
      }
      var tree = new Tree( params );

      tree.position.x = -2;
      tree.position.z = -.7;
      tree.position.y = -1;
      tree.scale.multiplyScalar( .8 );
      scene.add( tree );
      tree.add(sphere);



      var geo = new THREE.IcosahedronGeometry( .15 , 2 );
      var mat = new THREE.MeshNormalMaterial({opacity:0,transparent:true});

      var raytraceMat = new THREE.ShaderMaterial({
        uniforms: uniforms,
        vertexShader: shaders.vs.trace,
        fragmentShader: shaders.fs.trace,
      });



   
      for( var i = 0; i< songList.length; i++){

       
        var song = new Song( objectControls , i , titleList[i] , songList[i] , geo , mat );
        var angle = (i / songList.length);// * Math.PI  * 1.15 + Math.PI / 2;


        song.position.x =   .4;//uniforms.interfaceRadius.value  * Math.sin( angle );
        song.position.y =  2 * angle - .8;
        song.position.z = .2;//uniforms.interfaceRadius.value * Math.cos( angle );

        //song.position.normalize().multiplyScalar( 1.5 + .5 * Math.random() );


        G.monolith.add( song.body );

        songs.push( song );

        uniforms.links.value.push( new THREE.Vector4() );


        var p= i/songList.length

       // var geo = new THREE.CubeGeometry( 2 , 2 , 1 );

       
       var p1 = song.position.clone().add( new THREE.Vector3(.2 +(1- p) * .2 , 0 , 0));
       var p2 =  new THREE.Vector3(G.uniforms.dimensions.value.x * .45 + (1-p) * .2 , 1.3 , .2);
       var p3 =  new THREE.Vector3(G.uniforms.dimensions.value.x * .45 + (1-p) * .2 , 1.3 , -.3);
       var p4 =  new THREE.Vector3( (1-p) * .2 , .8-(1-p) * .2, -.3);
       var p5 =  new THREE.Vector3( -G.uniforms.dimensions.value.x * .5  , .8 -(1-p) * .2 , -.3);

        var p6 =  new THREE.Vector3( -.05 - G.uniforms.dimensions.value.x * .5 - (1-p) * .2  , .85 , -.3);
        var p7 =  new THREE.Vector3( -.05 - G.uniforms.dimensions.value.x * .5 - (1-p) * .2  , .85 , .3);
       /* var p8 =  new THREE.Vector3( -.05 - G.uniforms.dimensions.value.x * .5 - (1-p) * .2  , .5 - (p) * 1.5 , .3);

        var end =  new THREE.Vector3( -1  , .5 - (p) * 1.5 , .3);*/

         var p8 =  new THREE.Vector3( -.05 - G.uniforms.dimensions.value.x * .5 - (1-p) * .2  , -.6 + p * .2  , .3);

        var p9 =  new THREE.Vector3(  -G.uniforms.dimensions.value.x * .5+(p) * .2  , -.9 + p * .2  , .3);

        var p10 =  new THREE.Vector3(  -.2 + (p) * .2  , -.9 + p * .2  , .3);
        var p11 =  new THREE.Vector3(  -.1 + (p) * .3  , -1.   , .3);
        var p12 =  new THREE.Vector3(  .2 + (p) * .3  , -1.2   , .5);
        var p13 =  new THREE.Vector3(  .2 + (p) * .3  , -1.6   , 1.5);
        var p14 =  new THREE.Vector3(  .2 + (p) * .3  , -1.6   , 1.5 + 3. * (1-p)  );
        var end =  new THREE.Vector3(  1.  , -1.6   , 1.5 + 3. * (1-p) );

        //var end =  new THREE.Vector3( -1  , .5 - (p) * 1.3 , .3);

        var a = (p) * Math.PI * .5;

        var x =2.3* Math.sin( a );
        var y =2.3* Math.cos( a );

       // end = new THREE.Vector3( x , -1.5 , y ); 

        //var end =  new THREE.Vector3(  .2 + (p) * .3  , -1.6   , 1.5 + .2 * p );
        //end = new THREE.Vector3()
        var add = new THREE.Vector3( x , 0 , y);

          var points = [

            //song.position.clone(),
            song.position.clone() , 
            p1,
            p2,
            p3,
            p4,
            p5,
            p6,
            p7,
            p8, p9, p10, p11,p12,p13,p14,
            end


          ]

        var grow = GrowBar( points );


        G.monolith.add( grow );

        song.growBar = grow;

        song.titleBod.position.copy( end );
        song.titleBod.rotation.x = -Math.PI / 2 
        //song.titleBod.rotation.z = a -Math.PI / 2;

         //add.normalize();

         add = new THREE.Vector3(1,0,0);
         add.multiplyScalar(song.titleBod.totalWidth /2);


        song.titleBod.position.add( add);

        song.titleBod.hoverOver =  song.hoverOver.bind( song );
        song.titleBod.hoverOut =  song.hoverOut.bind( song );
        song.titleBod.select =  song.select.bind( song );

        objectControls.add( song.titleBod );

        G.monolith.add( song.titleBod );

      }

      var geo = new THREE.CubeGeometry( 60 , 60 ,3  );
      

      var light = new THREE.PointLight();

      mouse = new THREE.Mesh( new THREE.IcosahedronGeometry( .01 , 1 ), new THREE.MeshNormalMaterial());

      mouse.add( light );

      scene.add( mouse );



    var l = new THREE.PointLight();

      G.bait = new THREE.Mesh( new THREE.IcosahedronGeometry( .1 , 1 ), new THREE.MeshNormalMaterial());

      G.bait.add( light );

      scene.add( G.bait );

      G.bait.position.z = -4;
      G.bait.position.y = 2;
      G.bait.position.x = 2;


      var geo = new THREE.PlaneGeometry( 100000 , 100000 );
      var mat = new THREE.MeshNormalMaterial({side: THREE.DoubleSide, opacity: 0, transparent: true});
      intersectionPlane = new THREE.Mesh( geo , mat );
      intersectionPlane.position.z = 2;
      //intersectionPlane.visible = false;
      //scene.add( intersectionPlane );


      songs[0].select();




      G.DRAGON = new DragonFish( G.bait);



  }

  function animate(){

    requestAnimationFrame( animate );
    G.monolith.updateMatrixWorld();


    uniforms.iModelMat.value.getInverse( G.monolith.matrixWorld );

  uniforms.dT.value = clock.getDelta();
    uniforms.time.value += uniforms.dT.value;

    G.bait.position.x += Math.sin(uniforms.time.value * .6 + Math.sin(uniforms.time.value * .6 )) * .01;
    G.bait.position.y += Math.sin(uniforms.time.value * .6 + .3 ) * .01;
    G.bait.position.z += Math.sin( uniforms.time.value * .7 + .5 ) * .01;
    
    for( var i = 0 ; i < songs.length; i++ ){

      v1.copy( songs[i].position );

      //v1.applyMatrix4( uniforms.iModelMat.value );

      uniforms.links.value[i].x = v1.x;
      uniforms.links.value[i].y = v1.y;
      uniforms.links.value[i].z = v1.z;

      // TODO: set to if song hovered / played / etc
      uniforms.links.value[i].w = songs[i].hovered;

    }

    G.v1.set(0,0,0);// = new THREE.Vector3()
    G.v1.setFromMatrixPosition( G.light1.matrixWorld );
    uniforms.light1.value.set( G.v1.x , G.v1.y , G.v1.z , 1 );

    G.v1.set(0,0,0);// = new THREE.Vector3()
    G.v1.setFromMatrixPosition( G.light2.matrixWorld );
    uniforms.light2.value.set( G.v1.x , G.v1.y , G.v1.z , 1 );

    G.v1.set(0,0,0);// = new THREE.Vector3()
    G.v1.setFromMatrixPosition( G.light3.matrixWorld );
    uniforms.light3.value.set( G.v1.x , G.v1.y , G.v1.z , 1 );

  
    if( hoveredLink ){
      uniforms.hoveredLink.value.x = hoveredLink.position.x;
      uniforms.hoveredLink.value.y = hoveredLink.position.y;
      uniforms.hoveredLink.value.z = hoveredLink.position.z;
      uniforms.hoveredLink.value.w = 1;
    }else{
      uniforms.hoveredLink.value.x = 0;
      uniforms.hoveredLink.value.y = 0;
      uniforms.hoveredLink.value.z = 0;
      uniforms.hoveredLink.value.w = 0;
    }


    // Tween our activeLink uniform to actual uniform
    if( activeLink ){

      G.v1.copy( activeLink.position );

      G.v2.x = uniforms.activeLink.value.x;
      G.v2.y = uniforms.activeLink.value.y;
      G.v2.z = uniforms.activeLink.value.z;

      G.v1.copy( G.v2 );

      G.v1.sub(  activeLink.position );

      G.v1.multiplyScalar( -.1 );

      //G.v2.copy( activeLink.position );
      G.v1.add( G.v2 );


      uniforms.activeLink.value.x = G.v1.x;
      uniforms.activeLink.value.y = G.v1.y;
      uniforms.activeLink.value.z = G.v1.z;
      uniforms.activeLink.value.w = 1;

    }else{
      uniforms.activeLink.value.x = 0;
      uniforms.activeLink.value.y = 0;
      uniforms.activeLink.value.z = 0;
      uniforms.activeLink.value.w = 0;
    }


    uniforms.songVal.value = (finalSongVal - uniforms.songVal.value) * .1 +uniforms.songVal.value;


    intersectionPlane.lookAt( camera.position );



    iPoint = objectControls.raycaster.intersectObject( intersectionPlane );
    //1console.log( iPoint );

   if( iPoint[0] ) mouse.position.copy( iPoint[0].point );

   G.bait.position.copy( mouse.position );

    controls.update();
    objectControls.update();

    audio.update();

    TWEEN.update();

    G.DRAGON.update();
   

    renderer.render( scene , camera );
    stats.update();



  }



  function onWindowResize() {

    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();

    renderer.setSize( window.innerWidth, window.innerHeight );
   // grain.play();

  }

  function addLoad(){
    neededToLoad ++;
  }

  function onLoad(){
    numLoaded ++;
    console.log( numLoaded);
    console.log( neededToLoad);
    if( numLoaded == neededToLoad ){
      init();
      animate();
    }
  }


 function switchStream( newStream  ){

  var s = { v : stream.gain.gain.value } 
  var e = { v : 0 }
  var tween = new TWEEN.Tween( s ).to( e , 500 );

  this.tweenTMP = s;
  tween.audio = this.audio
  tween.onUpdate(function(){
    stream.gain.gain.value = this.tweenTMP.v;
    console.log( this.tweenTMP.v );
  }.bind( this));

  tween.onComplete( function(){


    console.log('ss')
    stream.audio.src = newStream;

    var t = new TWEEN.Tween({ v: 0 }).to( { v: 1 } , 500 );

    t.onUpdate(function(e){
      //console.log( e );
      stream.gain.gain.value = e
      //console.log( e.v );
    }.bind( this));

    t.onComplete( function(){

      console.log('sss')

      stream.play();

    })

    t.start();
  })

  tween.start();

}


</script>
 



</body>
<html>